# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- Initial project setup
- Repository hygiene files (.gitignore, README.md, CHANGELOG.md)
- Monorepo folder structure (apps/, src/, infra/, docs/)
- Architecture overview document (docs/architecture/overview.md)
- Environment template (.env.example)
- Docker Compose with nginx and postgres services (Phase 0.2a)
- Nginx placeholder page at localhost:8080
- PostgreSQL with health check and persistent volume
- Public-web and admin placeholder services (Phase 0.2b)
- Nginx reverse proxy routing: `/` -> public-web, `/admin/` -> admin
- .NET 10 minimal API stub with `/health` and `/info` endpoints (Phase 0.2c1)
- API Dockerfile with multi-stage build
- Repository .dockerignore file
- API service in Docker Compose (Phase 0.2c2)
- Nginx reverse proxy routing: `/api/*` -> api:5000
- Serilog logging for API: console + rolling file sink (Phase 0.2c3)
- API logs persisted to `_data/logs/api/` on host
- Shared uploads volume mounted to nginx and API (Phase 0.3a)
- Nginx serves `/uploads/*` as static files with cache headers
- Standardized uploads mount path to `/uploads` in all containers (Phase 0.3b)
- EF Core with PostgreSQL integration (Phase 1.1a)
- Pages table with JSONB sections column
- Automatic migrations at startup (Development only)
- `/api/db-check` endpoint for database connectivity verification
- EF Core entity configuration refactored to dedicated classes (Phase 1.1b1)
- pgcrypto extension migration for gen_random_uuid() support
- PostgreSQL exposed on configurable host port (default 5434) for external tools (Phase 1.1b2)
- Fixed migrations execution in Docker with ASPNETCORE_ENVIRONMENT=Development (Phase 1.1b3)
- pgcrypto extension now created in InitialCreate migration before pages table
- Improved migration logging with environment name and error handling
- GET `/api/pages/{slug}` endpoint to read published pages (Phase 1.1c)
- POST `/api/dev/seed` endpoint to seed sample data (Development only)
- PageDto for API responses (no direct entity exposure)
- JWT Bearer authentication infrastructure (Phase 1.2a1)
- JWT configuration in appsettings.json (Issuer, Audience, SigningKey)
- POST `/api/dev/token` endpoint to generate dev JWT tokens (Development only)
- GET `/api/auth/me` protected endpoint returning authenticated user info
- Central Package Management with pinned NuGet versions (Phase 1.2a1.1)
- Directory.Packages.props at repo root for version centralization
- NuGet lock file (packages.lock.json) for reproducible builds
- Pinned Docker images to exact versions (Phase 1.2a1.2)
  - nginx:1.28.1-alpine, postgres:16.11-alpine, .NET 10.0-alpine
- Directory.Build.props for NuGet lock file settings
- Dockerfile uses `--locked-mode` restore for reproducible builds
- Docker build context changed to repo root for Central Package Management
- Normalized auth tables with EF Core configuration (Phase 1.2a2)
  - `users` table with email unique index
  - `claims` table with (type, value) unique index
  - `user_claims` junction table (many-to-many)
  - Migration renamed from `AddAdminUsers` to `AddAuthTables` (no schema change)
- PBKDF2-SHA256 password hashing (`src/api/Security/PasswordHasher.cs`)
- POST `/api/auth/login` endpoint for real user authentication
- Dev seed now creates admin user with Admin role claim (admin@yigisoft.local / Admin123!)
- Production signing key enforcement (fail fast if dev placeholder or < 32 chars)
- Admin Pages CRUD endpoints (Phase 1.3a)
  - GET `/api/admin/pages` - list all pages (ordered by UpdatedAt desc)
  - GET `/api/admin/pages/{id}` - get page by ID
  - POST `/api/admin/pages` - create page with validation
  - PUT `/api/admin/pages/{id}` - update page
  - DELETE `/api/admin/pages/{id}` - hard delete page
  - POST `/api/admin/pages/{id}/publish` - publish page
  - POST `/api/admin/pages/{id}/unpublish` - unpublish page
- PageUpsertRequest and PageAdminListItemDto DTOs
- Slug validation: lowercase alphanumeric with hyphens (^[a-z0-9]+(?:-[a-z0-9]+)*$)
- Sections JSON validation: must be valid JSON array
- Slug conflict returns 409 with code "slug_conflict"
- Sections schema validation with type registry (Phase 1.3b)
  - Registry-based validation for section types: hero, features, cta
  - Each section must have `type` (string) and `data` (object)
  - Hero requires `data.title`; optional: `subtitle`, `imageUrl`, `primaryCta`
  - Features requires `data.title`, `data.items` (array, min 1); items require `title`
  - CTA requires `data.title`, `data.buttonText`, `data.buttonUrl`
  - Unknown section types return 400 with list of supported types
  - Validation errors include detailed paths: `sections[0].data.title is required`
  - Error format: `{ error: "ValidationFailed", details: [...] }`
- Admin uploads API endpoint (Phase 1.4a)
  - POST `/api/admin/uploads` - upload files via multipart/form-data
  - Saves files to `/uploads/{yyyy}/{MM}/{guid}.{ext}`
  - Allowed extensions: .png, .jpg, .jpeg, .webp, .svg, .pdf
  - Max file size: 10 MB
  - Returns 201 with `{ url, fileName, contentType, size }`
  - Nginx serves `/uploads/*` directly with cache headers
- Fixed dev seed sections JSON to match section schemas (1.3b consistency)
  - Hero: replaced `ctaText`/`ctaLink` with `primaryCta: { text, url }`
  - CTA: replaced `buttonLink` with `buttonUrl`
- Refactored Program.cs into bootstrap modules (Phase 1.4b)
  - `Bootstrap/ApiLoggingBootstrap.cs` - Serilog configuration
  - `Bootstrap/ApiServicesBootstrap.cs` - Service registrations (DbContext, Auth, Uploads)
  - `Bootstrap/ApiAppBootstrap.cs` - App pipeline (migrations, middleware, endpoints)
  - Program.cs reduced to thin composition root (~30 lines)
  - No behavior change; SOLID-friendly structure
- Swagger/OpenAPI documentation (Phase 1.5a)
  - Swagger UI available at `/api/swagger` (Development only)
  - OpenAPI JSON at `/api/swagger/v1/swagger.json`
  - JWT Bearer security scheme for "Authorize" button
  - API metadata: title, version, description
  - Added Swashbuckle.AspNetCore 7.2.0
- Uploads metadata persistence and management (Phase 1.5b)
  - `uploads` table: id, storage_path, url, file_name, original_file_name, content_type, size, created_at, uploaded_by_user_id
  - POST `/api/admin/uploads` now returns `id` and saves metadata to DB
  - GET `/api/admin/uploads` - list uploads (optional `take` param, default 50, max 200)
  - DELETE `/api/admin/uploads/{id}` - delete upload (DB record + file from disk)
- Documentation improvements for PowerShell 5.1 compatibility (Phase 1.6a)
  - README Uploads section now includes PS7+ and PS5.1 compatible examples
  - Added `curl.exe` examples for Windows PowerShell 5.1 (which lacks `-Form` parameter)
  - Added inline test.png generation snippet (base64 1x1 PNG) for easy testing
  - Bash/Linux examples reorganized for clarity
  - Verified Program.cs remains minimal (~30 lines, SOLID-friendly)
