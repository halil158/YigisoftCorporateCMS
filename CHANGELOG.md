# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- Initial project setup
- Repository hygiene files (.gitignore, README.md, CHANGELOG.md)
- Monorepo folder structure (apps/, src/, infra/, docs/)
- Architecture overview document (docs/architecture/overview.md)
- Environment template (.env.example)
- Docker Compose with nginx and postgres services (Phase 0.2a)
- Nginx placeholder page at localhost:8080
- PostgreSQL with health check and persistent volume
- Public-web and admin placeholder services (Phase 0.2b)
- Nginx reverse proxy routing: `/` -> public-web, `/admin/` -> admin
- .NET 10 minimal API stub with `/health` and `/info` endpoints (Phase 0.2c1)
- API Dockerfile with multi-stage build
- Repository .dockerignore file
- API service in Docker Compose (Phase 0.2c2)
- Nginx reverse proxy routing: `/api/*` -> api:5000
- Serilog logging for API: console + rolling file sink (Phase 0.2c3)
- API logs persisted to `_data/logs/api/` on host
- Shared uploads volume mounted to nginx and API (Phase 0.3a)
- Nginx serves `/uploads/*` as static files with cache headers
- Standardized uploads mount path to `/uploads` in all containers (Phase 0.3b)
- EF Core with PostgreSQL integration (Phase 1.1a)
- Pages table with JSONB sections column
- Automatic migrations at startup (Development only)
- `/api/db-check` endpoint for database connectivity verification
- EF Core entity configuration refactored to dedicated classes (Phase 1.1b1)
- pgcrypto extension migration for gen_random_uuid() support
- PostgreSQL exposed on configurable host port (default 5434) for external tools (Phase 1.1b2)
- Fixed migrations execution in Docker with ASPNETCORE_ENVIRONMENT=Development (Phase 1.1b3)
- pgcrypto extension now created in InitialCreate migration before pages table
- Improved migration logging with environment name and error handling
- GET `/api/pages/{slug}` endpoint to read published pages (Phase 1.1c)
- POST `/api/dev/seed` endpoint to seed sample data (Development only)
- PageDto for API responses (no direct entity exposure)
- JWT Bearer authentication infrastructure (Phase 1.2a1)
- JWT configuration in appsettings.json (Issuer, Audience, SigningKey)
- POST `/api/dev/token` endpoint to generate dev JWT tokens (Development only)
- GET `/api/auth/me` protected endpoint returning authenticated user info
- Central Package Management with pinned NuGet versions (Phase 1.2a1.1)
- Directory.Packages.props at repo root for version centralization
- NuGet lock file (packages.lock.json) for reproducible builds
- Pinned Docker images to exact versions (Phase 1.2a1.2)
  - nginx:1.28.1-alpine, postgres:16.11-alpine, .NET 10.0-alpine
- Directory.Build.props for NuGet lock file settings
- Dockerfile uses `--locked-mode` restore for reproducible builds
- Docker build context changed to repo root for Central Package Management
- Normalized auth tables with EF Core configuration (Phase 1.2a2)
  - `users` table with email unique index
  - `claims` table with (type, value) unique index
  - `user_claims` junction table (many-to-many)
  - Migration renamed from `AddAdminUsers` to `AddAuthTables` (no schema change)
- PBKDF2-SHA256 password hashing (`src/api/Security/PasswordHasher.cs`)
- POST `/api/auth/login` endpoint for real user authentication
- Dev seed now creates admin user with Admin role claim (admin@yigisoft.local / Admin123!)
- Production signing key enforcement (fail fast if dev placeholder or < 32 chars)
- Admin Pages CRUD endpoints (Phase 1.3a)
  - GET `/api/admin/pages` - list all pages (ordered by UpdatedAt desc)
  - GET `/api/admin/pages/{id}` - get page by ID
  - POST `/api/admin/pages` - create page with validation
  - PUT `/api/admin/pages/{id}` - update page
  - DELETE `/api/admin/pages/{id}` - hard delete page
  - POST `/api/admin/pages/{id}/publish` - publish page
  - POST `/api/admin/pages/{id}/unpublish` - unpublish page
- PageUpsertRequest and PageAdminListItemDto DTOs
- Slug validation: lowercase alphanumeric with hyphens (^[a-z0-9]+(?:-[a-z0-9]+)*$)
- Sections JSON validation: must be valid JSON array
- Slug conflict returns 409 with code "slug_conflict"
- Sections schema validation with type registry (Phase 1.3b)
  - Registry-based validation for section types: hero, features, cta
  - Each section must have `type` (string) and `data` (object)
  - Hero requires `data.title`; optional: `subtitle`, `imageUrl`, `primaryCta`
  - Features requires `data.title`, `data.items` (array, min 1); items require `title`
  - CTA requires `data.title`, `data.buttonText`, `data.buttonUrl`
  - Unknown section types return 400 with list of supported types
  - Validation errors include detailed paths: `sections[0].data.title is required`
  - Error format: `{ error: "ValidationFailed", details: [...] }`
- Admin uploads API endpoint (Phase 1.4a)
  - POST `/api/admin/uploads` - upload files via multipart/form-data
  - Saves files to `/uploads/{yyyy}/{MM}/{guid}.{ext}`
  - Allowed extensions: .png, .jpg, .jpeg, .webp, .svg, .pdf
  - Max file size: 10 MB
  - Returns 201 with `{ url, fileName, contentType, size }`
  - Nginx serves `/uploads/*` directly with cache headers
- Fixed dev seed sections JSON to match section schemas (1.3b consistency)
  - Hero: replaced `ctaText`/`ctaLink` with `primaryCta: { text, url }`
  - CTA: replaced `buttonLink` with `buttonUrl`
- Refactored Program.cs into bootstrap modules (Phase 1.4b)
  - `Bootstrap/ApiLoggingBootstrap.cs` - Serilog configuration
  - `Bootstrap/ApiServicesBootstrap.cs` - Service registrations (DbContext, Auth, Uploads)
  - `Bootstrap/ApiAppBootstrap.cs` - App pipeline (migrations, middleware, endpoints)
  - Program.cs reduced to thin composition root (~30 lines)
  - No behavior change; SOLID-friendly structure
- Swagger/OpenAPI documentation (Phase 1.5a)
  - Swagger UI available at `/api/swagger` (Development only)
  - OpenAPI JSON at `/api/swagger/v1/swagger.json`
  - JWT Bearer security scheme for "Authorize" button
  - API metadata: title, version, description
  - Added Swashbuckle.AspNetCore 7.2.0
- Uploads metadata persistence and management (Phase 1.5b)
  - `uploads` table: id, storage_path, url, file_name, original_file_name, content_type, size, created_at, uploaded_by_user_id
  - POST `/api/admin/uploads` now returns `id` and saves metadata to DB
  - GET `/api/admin/uploads` - list uploads (optional `take` param, default 50, max 200)
  - DELETE `/api/admin/uploads/{id}` - delete upload (DB record + file from disk)
- Documentation improvements for PowerShell 5.1 compatibility (Phase 1.6a)
  - README Uploads section now includes PS7+ and PS5.1 compatible examples
  - Added `curl.exe` examples for Windows PowerShell 5.1 (which lacks `-Form` parameter)
  - Added inline test.png generation snippet (base64 1x1 PNG) for easy testing
  - Bash/Linux examples reorganized for clarity
  - Verified Program.cs remains minimal (~30 lines, SOLID-friendly)
- Rate limiting and real client IP behind nginx (Phase 1.6a)
  - POST `/api/auth/login` rate limited to 5 requests/min per client IP
  - POST `/api/admin/uploads` rate limited to 30 requests/min per client IP
  - 429 response as JSON: `{ error: "RateLimited", message: "Too many requests", retryAfterSeconds: N }`
  - Forwarded headers middleware enabled to get real client IP from nginx
  - Uses built-in Microsoft.AspNetCore.RateLimiting (no external dependencies)
- Section type registry expansion (Phase 1.6b)
  - Added `testimonials` section: title + items with quote/name (optional: role, company, avatarUrl)
  - Added `gallery` section: title + items with imageUrl (optional: alt, caption)
  - Added `contact-form` section: title, recipientEmail, fields with name/label/type
  - Contact form field types: text, email, textarea, phone
  - Duplicate field name detection in contact-form
  - Basic email validation (contains @ and no spaces)
- Contact form submissions (Phase 1.7a)
  - `contact_messages` table: id, page_slug, recipient_email, fields (jsonb), created_at, ip, user_agent, processed_at
  - POST `/api/pages/{slug}/contact` - public endpoint to submit contact form
    - Validates submission against page's contact-form section schema
    - Enforces required fields, email format, phone format
    - Rate limited to 10 requests/hour per IP
    - Returns 202 Accepted with { id, createdAt }
  - GET `/api/admin/contact-messages` - list messages (ordered by created_at desc)
  - GET `/api/admin/contact-messages/{id}` - get message with full fields JSON
  - PATCH `/api/admin/contact-messages/{id}/mark-processed` - mark message as processed
- Contact messages admin filtering (Phase 1.7b)
  - GET `/api/admin/contact-messages` now supports filtering & pagination:
    - `pageSlug` (string) - filter by page slug
    - `processed` (bool) - filter by processed status (true = has processedAt, false = no processedAt)
    - `skip` (int, default 0) - pagination offset
    - `take` (int, default 50, max 200) - pagination limit
  - Uses AsNoTracking for better performance
- Composition root refactor (Phase 1.8a)
  - Program.cs reduced to thin composition root (~33 lines)
  - Service registrations moved to `ServiceCollectionExtensions.cs`:
    - `AddApiServices()` orchestrator with smaller focused methods
    - `AddDatabase()`, `AddApiAuthentication()`, `AddApiRateLimiting()`, `AddUploads()`, `AddSwaggerDocumentation()`
  - Pipeline configuration moved to `WebApplicationExtensions.cs`:
    - `UseApiPipeline()` handles migrations, forwarded headers, swagger, rate limiter, auth
  - Removed obsolete Bootstrap files (`ApiServicesBootstrap.cs`, `ApiAppBootstrap.cs`)
  - Kept `ApiLoggingBootstrap.cs` for Serilog configuration
  - No behavior changes; all endpoints and middleware function identically
- Integration tests with Testcontainers (Phase 1.8b)
  - New test project: `tests/api/YigisoftCorporateCMS.Api.Tests`
  - Custom `ApiWebApplicationFactory` using PostgreSQL Testcontainer
  - Tests for: health/info, auth (login, protected endpoints), admin pages CRUD, admin uploads
  - GitHub Actions CI workflow (`.github/workflows/ci.yml`)
  - Packages: xUnit, Microsoft.AspNetCore.Mvc.Testing, Testcontainers.PostgreSql
- CI quality gate improvements (Phase 1.8c)
  - NuGet package caching with `actions/cache@v4` for faster CI builds
  - Cache key includes OS, Directory.Packages.props, packages.lock.json, and *.csproj files
  - Code coverage collection using XPlat Code Coverage (coverlet)
  - ReportGenerator for HTML coverage reports
  - Coverage report uploaded as CI artifact (30-day retention)
  - Coverage summary displayed in CI logs
- CI locked-mode enforcement (Phase 1.8d)
  - `dotnet restore --locked-mode` in CI workflow for deterministic builds
  - CI fails if packages.lock.json is out of sync with package references
  - ReportGenerator step now includes PATH fix for dotnet tools
- Admin UI scaffold (Phase 2.0)
  - React + Vite + TypeScript app in `apps/admin`
  - Configured for `/admin/` subpath (Vite base + React Router basename)
  - JWT auth flow: login page calls `/api/auth/login`, stores token in localStorage
  - ProtectedRoute wrapper redirects to login when unauthenticated
  - API client with automatic `Authorization: Bearer` header
  - Dashboard placeholder page with logout
  - Multi-stage Docker build (node build -> nginx serve)
  - SPA routing with nginx try_files fallback
- Admin Pages UI (Phase 2.1)
  - Pages list at `/admin/pages` with table: slug, title, published, updatedAt, actions
  - Create page at `/admin/pages/new` with slug, title, sections JSON textarea
  - Edit page at `/admin/pages/:id` with metaTitle, metaDescription, slug warning
  - Publish/unpublish and delete actions from list and edit pages
  - Validation error display with detailed messages
  - AdminLayout component with sidebar navigation
  - API error handling: 401/403 redirects to login
- Admin Media Library (Phase 2.2)
  - Media library at `/admin/media` with upload, list, and delete functionality
  - File upload via multipart/form-data to `/api/admin/uploads`
  - Image preview (max 120px), PDF badge, generic file icon
  - Copy URL button copies absolute public URL to clipboard
  - Open link opens file in new tab
  - Delete with confirmation removes file and database record
  - Allowed files: PNG, JPG, JPEG, WebP, SVG, PDF (max 10 MB)

- Admin Contact Messages UI (Phase 2.3)
  - Contact messages list at `/admin/contact-messages` with filtering and pagination
  - Filter by status (All, Unprocessed, Processed) and page slug
  - Pagination with configurable page size (20/50/100)
  - Contact message detail view at `/admin/contact-messages/:id`
  - View submitted fields as pretty-printed JSON
  - Mark as processed action updates processedAt
  - Sidebar navigation updated with Contact Messages link

- Admin UI Theme + Dark Mode (Phase 2.4)
  - Tailwind CSS integration with custom color palette
  - Dark mode with system preference detection and localStorage persistence
  - Theme toggle button in topbar (sun/moon icons)
  - Reusable UI components: Button, Input, Select, TextArea, Card, Table, Alert
  - Modern layout: fixed sidebar (240px) with navigation icons, topbar with title and actions
  - Visual style: light gray background, white cards, subtle borders, rounded corners
  - Responsive design with consistent spacing
  - Invalid dates display as "—" instead of "Invalid Date"

- Yigisoft Brand Green Accent (Phase 2.4b)
  - Replaced blue primary color with Yigisoft brand green palette
  - Brand colors: 50 #EFFBED → 500 #36CC1D → 900 #1B660E
  - Updated all primary UI elements: buttons, links, focus rings, sidebar active state
  - Success states now use emerald (teal-green) to remain distinct from brand
  - Published/Processed badges updated to emerald for visual distinction

- Admin UI Polish (Phase 2.4c)
  - Fixed dark mode button colors: now use darker muted green (accent-dark) instead of neon
  - Added RowActionsMenu component: reusable 3-dots kebab menu for table actions
  - Replaced inline action links/buttons with kebab menu on:
    - Pages list: Edit, Publish/Unpublish, Delete
    - Media Library: Copy URL, Open, Delete
    - Contact Messages list: View
  - Actions column now right-aligned for cleaner table layout

- Admin UX Polish (Phase 2.4.3)
  - ConfirmDialog component for destructive actions:
    - Focus trap, ESC to close, click outside to close
    - Red "danger" variant for delete, yellow "warning" variant for unpublish
    - Loading state with spinner during async operations
    - Works in light/dark theme
  - Toast notification system:
    - `toast.success()`, `toast.error()`, `toast.info()` methods
    - Auto-dismiss after 4 seconds, manual dismiss via X button
    - Slide-in animation from right, stacked at bottom-right
    - Standardized error message extraction with `extractErrorMessage()`
  - Table states for consistent loading/empty/error UX:
    - `TableLoading`: skeleton rows with animated pulse
    - `TableEmpty`: centered icon and message (document/image/message icons)
    - `TableError`: error message with "Try Again" retry button
  - Applied to all list pages: Pages, Media Library, Contact Messages
  - Toast notifications on: create, update, delete, publish, unpublish, upload, copy URL, mark processed

- Admin UI Consistency Polish (Phase 2.4.4)
  - Badge component with 5 variants: success, warning, neutral, info, danger
    - Two sizes: sm (default), md
    - Consistent styling across light/dark modes
  - PageHeader component for consistent page header layout
    - Optional description and actions slot
    - Responsive flex layout
  - Button component improvements:
    - Focus rings (focus:ring-2 focus:ring-offset-2) for all variants
    - New ghost variant for minimal UI
  - Input, TextArea, Select improvements:
    - Disabled state styling (bg-gray-100, cursor-not-allowed)
    - Placeholder text color standardized (text-gray-400)
    - Smooth transitions on focus
    - Error state support on Select
  - Table component polish:
    - Header border-b for visual separation
    - Lighter row dividers (divide-gray-100)
    - Subtle hover transition (duration-100)
    - Increased cell padding for breathing room
  - TableEmpty enhancement:
    - Title, message, icon props for better empty states
    - Optional action button (e.g., "+ Create Page")
  - Applied consistent components across all list pages:
    - PagesListPage: Badge for status, PageHeader, enhanced TableEmpty with action
    - MediaLibraryPage: Badge for file types, PageHeader, enhanced TableEmpty with action
    - ContactMessagesListPage: Badge for processed status, enhanced TableEmpty
    - ContactMessageDetailPage: Badge for processed status

- Upload Image Resize + Thumbnails (Phase 2.5)
  - Image processing with SixLabors.ImageSharp 3.1.6
  - Auto-resize raster images (JPEG, PNG, WebP):
    - Main image capped at 2000px max dimension
    - Thumbnail generated at 320px max dimension (WebP format)
    - EXIF auto-orient applied before resizing
  - New database columns: `thumbnail_storage_path`, `thumbnail_url`, `width`, `height`
  - Upload response includes: `thumbnailUrl`, `width`, `height`
  - GET `/api/admin/uploads` returns thumbnail info for all uploads
  - DELETE `/api/admin/uploads/{id}` removes both main file and thumbnail
  - Thumbnails stored in `/uploads/thumbs/{uploadId}.webp`
  - Nginx serves `/uploads/thumbs/` with 30-day cache (immutable thumbnails)
  - Admin Media Library uses thumbnail for preview (faster list rendering)
  - Non-image files (PDF, SVG) remain unchanged

- Admin Page Builder (Phase 2.6)
  - Visual section builder replaces raw JSON editing for page sections
  - `SectionBuilder` component with drag-free reorder controls (move up/down)
  - `SectionCard` collapsible cards per section with type badge and actions
  - Six section type editors:
    - `HeroEditor`: title, subtitle, imageUrl, primary CTA (text + URL)
    - `FeaturesEditor`: title + items array (title, description, icon per item)
    - `CtaEditor`: title, button text, button URL
    - `TestimonialsEditor`: title + items array (quote, name, role, company, avatarUrl)
    - `GalleryEditor`: title + items array (imageUrl, alt, caption)
    - `ContactFormEditor`: title, recipient email, description, submit text, fields array
  - `MediaPickerModal` for browsing and selecting images from uploads library
  - `ImageInput` component combines text input with media picker button and preview
  - "Switch to Advanced (JSON)" toggle preserves raw JSON editing for power users
  - Bidirectional sync between visual builder and JSON textarea
  - Server validation errors mapped to specific section fields
  - Applied to both PageCreatePage and PageEditPage

### Fixed
- Tuned brand green accent for dark mode readability
  - Added softer accent variants (accent-soft, accent-muted) for dark mode
  - Primary buttons, focus rings, and links now use reduced-saturation green in dark mode
  - Sidebar active state uses subtle green tint background in dark mode
  - Logo icons use softer green in dark mode to reduce eye strain
- nginx `client_max_body_size` set to 12m for `/api/` to allow uploads up to 10 MB (was defaulting to 1 MB, causing 413 errors)
- Added favicon and icon assets to both public-web and admin apps (fixes 404 on /favicon.ico)
  - favicon.ico, favicon.svg, favicon-16x16.png, favicon-32x32.png
  - apple-touch-icon.png for iOS devices
  - og-image.png for social media sharing
  - Theme color meta tag (#2980b9)
- PATCH `/api/admin/contact-messages/{id}/mark-processed` now returns full detail DTO (Phase 2.3.1)
  - Previously returned only `{ id, processedAt }`, causing admin UI to lose other fields after marking processed
  - Now returns same shape as GET endpoint: id, pageSlug, recipientEmail, fields, createdAt, ip, userAgent, processedAt
  - Endpoint is now idempotent: calling on already-processed message returns full DTO without error
